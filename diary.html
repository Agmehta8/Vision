<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vision – Diary</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="diary-page">
  <main class="diary-main">
    <a href="index.html" class="topic-link diary-back">Back to Home</a>
    <header class="diary-header">
      <h1 class="diary-date">January 24, 2026</h1>
    </header>
    <div class="diary-entry-wrapper">
      <div class="diary-ghost" aria-hidden="true">
        <span class="ghost-typed"></span><span class="ghost-suggestion"></span><span class="ghost-arrow"></span>
      </div>
      <button class="diary-ghost-action" type="button" aria-label="Accept suggestion"></button>
      <textarea class="diary-entry" placeholder="Write your thoughts..."></textarea>
    </div>
  </main>
  <script>
    const phrases = [
      "Today I felt...",
      "The weather was...",
      "I am grateful for...",
      "Something that surprised me today was...",
      "A lesson I learned was...",
      "I want to remember..."
    ];

    const wrapper = document.querySelector(".diary-entry-wrapper");
    const textarea = document.querySelector(".diary-entry");
    const ghostLayer = document.querySelector(".diary-ghost");
    const ghostTyped = document.querySelector(".ghost-typed");
    const ghostSuggestion = document.querySelector(".ghost-suggestion");
    const ghostArrow = document.querySelector(".ghost-arrow");
    const ghostAction = document.querySelector(".diary-ghost-action");

    let suggestion = "";
    let debounceTimer;
    let touchStartX = 0;
    let touchStartY = 0;

    const updateGhostActionPosition = () => {
      if (!suggestion) {
        ghostAction.style.display = "none";
        return;
      }

      const suggestionRect = ghostSuggestion.getBoundingClientRect();
      const wrapperRect = wrapper.getBoundingClientRect();

      ghostAction.style.display = "block";
      ghostAction.style.left = `${suggestionRect.left - wrapperRect.left}px`;
      ghostAction.style.top = `${suggestionRect.top - wrapperRect.top}px`;
      ghostAction.style.width = `${suggestionRect.width}px`;
      ghostAction.style.height = `${suggestionRect.height}px`;
    };

    const renderSuggestion = (text, matchedPhrase) => {
      const remaining = matchedPhrase.slice(text.length);
      suggestion = remaining ? matchedPhrase : "";

      ghostTyped.textContent = text;
      ghostSuggestion.textContent = remaining;
      ghostArrow.textContent = remaining ? " →" : "";

      requestAnimationFrame(updateGhostActionPosition);
    };

    const clearSuggestion = () => {
      suggestion = "";
      ghostTyped.textContent = textarea.value;
      ghostSuggestion.textContent = "";
      ghostArrow.textContent = "";
      ghostAction.style.display = "none";
    };

    const findSuggestion = () => {
      const text = textarea.value;
      if (!text) {
        clearSuggestion();
        return;
      }

      const match = phrases.find((phrase) =>
        phrase.toLowerCase().startsWith(text.toLowerCase())
      );

      if (!match || match.length === text.length) {
        clearSuggestion();
        return;
      }

      renderSuggestion(text, match);
    };

    const debouncedFindSuggestion = () => {
      window.clearTimeout(debounceTimer);
      debounceTimer = window.setTimeout(findSuggestion, 300);
    };

    const acceptSuggestion = () => {
      if (!suggestion) {
        return;
      }
      textarea.value = suggestion;
      textarea.dispatchEvent(new Event("input", { bubbles: true }));
      textarea.focus();
    };

    textarea.addEventListener("input", () => {
      ghostTyped.textContent = textarea.value;
      ghostSuggestion.textContent = "";
      ghostArrow.textContent = "";
      suggestion = "";
      ghostAction.style.display = "none";
      debouncedFindSuggestion();
    });

    textarea.addEventListener("scroll", () => {
      ghostLayer.scrollTop = textarea.scrollTop;
      ghostLayer.scrollLeft = textarea.scrollLeft;
      updateGhostActionPosition();
    });

    textarea.addEventListener("keydown", (event) => {
      if (event.key === "Tab" && suggestion) {
        event.preventDefault();
        acceptSuggestion();
      }
    });

    textarea.addEventListener("touchstart", (event) => {
      const touch = event.touches[0];
      touchStartX = touch.clientX;
      touchStartY = touch.clientY;
    }, { passive: true });

    textarea.addEventListener("touchend", (event) => {
      const touch = event.changedTouches[0];
      const deltaX = touch.clientX - touchStartX;
      const deltaY = touch.clientY - touchStartY;
      if (deltaX > 50 && Math.abs(deltaY) < 30) {
        acceptSuggestion();
      }
    });

    ghostAction.addEventListener("click", acceptSuggestion);

    window.addEventListener("resize", () => {
      updateGhostActionPosition();
    });

    clearSuggestion();
  </script>
</body>
</html>
